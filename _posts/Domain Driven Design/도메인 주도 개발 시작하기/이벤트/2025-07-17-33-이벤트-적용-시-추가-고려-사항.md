---
layout: single
title: "6. 이벤트 적용 시 추가 고려 사항"
categories:
  - Domain Driven Design
  - 도메인 주도 개발 시작하기
  - 이벤트
tags:
  - DDD
  - 이벤트
  - 이벤트적용
  - 고려사항
toc: true
toc_sticky: true
---


# 1. 이벤트 관점 고려 사항

## 이벤트 발생 주체 정보

- `EventEntry`는 이벤트 발생 주체에 대한 정보를 갖지 않음
- 특정 주체가 발생시킨 이벤트만 조회해야 하는 경우, 발생 주체 정보를 추가해야

## 포워더의 전송 실패 처리

- 포워더는 이벤트 전송 실패 시, 실패한 이벤트부터 다시 읽어와 전송을 시도
- 하지만 특정 이벤트에서 계속 전송에 실패하면, 나머지 이벤트를 전송할 수 없게 됨
- 따라서 처리 실패 이벤트의 재전송 횟수 제한을 두어야
- 처리에 실패한 이벤트를 생략하지 않고 실패용 DB나 메시지 큐에 저장하기도

## 이벤트 손실

- 이벤트 저장소 사용 시, 이벤트 발생/저장을 한 트랜잭션으로 처리
    - 트랜잭션에 성공하면 이벤트가 저장소에 보관된다는 것을 보장

- 하지만 로컬 핸들러 사용 시, 이벤트 처리에 실패하면 이벤트는 유실됨

## 이벤트 순서

- 이벤트 발생 순서대로 외부 시스템에 전달해야 하는 경우, 순서대로 저장하는 이벤트 저장소를 사용하는 것이 좋음
- 반면 메시징 시스템은 이벤트 발생 순서와 메시지 전달 순서가 다를 수도

## 이벤트 재처리

- 동일한 이벤트를 재처리해야 할 경우의 동작을 결정해야
    - 마지막으로 처리한 이벤트의 순번을 기억해, 이미 처리한 순번의 이벤트가 오면 무시
    - 이벤트를 멱등으로 처리

# 2. DB 트랜잭션 관점 고려 사항

- 주문 취소와 환불 기능을 다음과 같이 이벤트를 이용해 구현
    
    
    
    1. **주문 취소 기능**: 주문 취소 이벤트를 발생시킴
    2. **주문 취소 이벤트 핸들러**: 환불 서비스에 환불 처리를 요청
    3. **환불 서비스**: 외부 API를 호출해서 결제를 취소
    
    

## 문제 (1): 동기 처리 시 트랜잭션 실패

- 이벤트 발생/처리를 동기로 처리하면 실행 흐름은 다음과 같음

![image.png](/assets/images/Domain Driven Design/도메인 주도 개발 시작하기/이벤트/33-이벤트-적용-시-추가-고려-사항/image.png)

- 이때 13번 과정에서 실패하면, 결제는 취소됐으나 DB에는 주문이 취소되지 않은 상태로 남게 됨

## 문제 (2): 비동기 처리 시 이벤트 처리 실패

- 이벤트 발생/처리를 비동기로 처리하면 실행 흐름은 다음과 같음

![image.png](/assets/images/Domain Driven Design/도메인 주도 개발 시작하기/이벤트/33-이벤트-적용-시-추가-고려-사항/image%201.png)

- 이때 12번 과정에서 실패하면, DB에는 주문이 취소된 상태지만 결제는 취소되지 않은 상태로 남게 됨

## 해결책 (1): `@TransactionalEventListener`

- `@TransactionalEventListener`로 트랜잭션 상태에 따라 이벤트 핸들러 실행 가능
    
    ```java
    @TransactionalEventListener(
    		classes = OrderCanceledEvent.class,
    		phase = TransactionPhase.AFTER_COMMIT
    )
    public void handle(OrderCanceledEvent event) {
    	refundService.refund(event.getOrderNumber());
    }
    ```
    
    - `TransactionPhase.AFTER_COMMIT`: 트랜잭션 커밋 성공 후 핸들러 메서드 실행

- 이제 이벤트 처리 실패만 고민하면 됨

## 해결책 (2): 이벤트 특성에 따라 재처리 방식 결정

---