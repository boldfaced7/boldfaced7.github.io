---
layout: single
title: "Next 코어뱅킹, MSA와 MySQL로 여는 평생 무료 환전 시대"
categories:
  - MSA
  - 빅테크 기술 블로그
  - Toss
tags:
  - MSA
  - 코어뱅킹
  - 마이크로서비스
  - 토스뱅크
  - MySQL
  - 환전 시스템
  - 아키텍처
toc: true
toc_sticky: true
---
> [**토스ㅣSLASH 24 - Next 코어뱅킹, MSA와 MySQL로 여는 평생 무료 환전 시대**](https://www.youtube.com/watch?v=uWnAVYgCd0k)


# 1️⃣ 토스뱅크의 기술 전환

## **❓** 문제: Oracle ()의존적인 MSA

![image.png](/assets/images/MSA/빅테크 기술 블로그/Toss/03-Next 코어뱅킹, MSA와 MySQL로 여는 평생 무료 환전 시대/image.png)

### Oracle 장점



- **안정성:** 트랜잭션 관리, 고가용성, 복구 기능, 데이터 무결성 보장등의 측면에서 좋음
- **확장성:** 매우 큰 데이터 볼륨을 처리할 수 있는 뛰어난 확장성
- **성능:** 복잡한 트랜잭션 처리와 대규모 데이터베이스 쿼리에 효과적
- **오랜 기간 축적된 노하우**


### Oracle 단점



- **제한적인 Scale Out:** 유연한 대처가 어렵고 SPOF가 발생
- MySQL 대비 **비싼 라이센스** 비용
    - CPU 코어 수에 비례하여 비용이 증가
    - 따라서 각 마이크로서버에게 Oracle DB를 각각 붙일 수 없음


## **❗** 해결책: MySQL 도입

### **유리한 확장성**

- Replication 전략으로 유연한 Scale Out이 가능하고, 비용도 Oracle 대비 저렴

### **안정성**

- MVCC 기술로 효율적으로 동시성을 제어

### **트랜잭션 관리의 진화**

- 기존에는 데이터베이스에서 트랜잭션을 직접 제어해야
- Redis 분산 락, Kafka를 활용한 SAGA  패턴 등으로 Application 레이어에서도 효율적으로 트랜잭션 관리가 가능

# 2️⃣ 기술 비교: 원화예금 vs 외화예금 시스템 구조

## `Old` 원화예금 시스템

- 기존의 레거시(모놀리식) 코어뱅킹 서버(원화예금 서버) 기능을 마이크로 서버로 분리 중
    
    ![image.png](/assets/images/MSA/빅테크 기술 블로그/Toss/03-Next 코어뱅킹, MSA와 MySQL로 여는 평생 무료 환전 시대/image.png)
    

- 대표적으로 지금 이자 받기, 송금, 원장 관리와 같은 도메인을 새롭게 MSA로 구현 중
    - 물론 데이터베이스는 오라클 DB를 바라 보고 있는 상황

## `New` 외화예금 시스템

- 외화예금 서버는 MySQL과 마이크로 서버로 새롭게 디자인
    
    ![image.png](/assets/images/MSA/빅테크 기술 블로그/Toss/03-Next 코어뱅킹, MSA와 MySQL로 여는 평생 무료 환전 시대/image%201.png)
    

# 3️⃣ 외화예금 트랜잭션 아키텍처

- 사용자에게 빠른 환전 경험을 제공하기 위해, 트랜잭션이 전반적으로 느슨하게 연결되도록 설계
    
    ![image.png](/assets/images/MSA/빅테크 기술 블로그/Toss/03-Next 코어뱅킹, MSA와 MySQL로 여는 평생 무료 환전 시대/image%202.png)
    
    - 단, 고객의 잔액 관리(외환, 수신 외화예금 서버)만큼은 서버 간 트랜잭션을 엄격하게 관리
    - 하지만 고객과 관련 없이 은행 내부적으로 회계 처리를 위한 서버(손익 처리, 회계 처리, 계정계 서버) 간의 트랜잭션을 카프카를 활용해 비동기적으로 처리

## 환전 거래 금원 흐름

- 다음 플로우로 사용자의 원화가 외화로 환전되며, 은행의 총계정원장 금액이 변경됨
    
    ![image.png](/assets/images/MSA/빅테크 기술 블로그/Toss/03-Next 코어뱅킹, MSA와 MySQL로 여는 평생 무료 환전 시대/image%203.png)
    

### 고객 계좌 처리

- 빠른 환전 경험 제공을 위해, 고객 계좌 처리 트랜잭션을 SAGA 패턴으로 묶어 관리
    
    ![image.png](/assets/images/MSA/빅테크 기술 블로그/Toss/03-Next 코어뱅킹, MSA와 MySQL로 여는 평생 무료 환전 시대/image%204.png)
    
    
    
    1. **고객**: 환전 요청
    2. **외환 서버**: 어떤 종류의 환전인지 확인하고 환율을 확정
    3. **수신 원화예금 서버**: 원화 계좌에서 출금 
    4. **수신 외화예금 서버**: 외화 계좌에 돈을 입금
    
    

### 은행 계좌 처리

- 은행 계좌 처리는 카프카를 이용해 트랜잭션을 분리
    
    ![image.png](/assets/images/MSA/빅테크 기술 블로그/Toss/03-Next 코어뱅킹, MSA와 MySQL로 여는 평생 무료 환전 시대/image%205.png)
    
    
    
    1. **손익 서버**: 외환 서버가 발행한 메시지를 컨슘해, 환율에 따른 손익 결정
    2. **회계 처리 서버**: 손익 서버가 발행한 메시지를 컨슘해, 은행의 어떤 계좌에 얼마를 기록할지 오라클에 기록
    3. **계정계 서버**: 회계 처리 서버가 오라클에 기록한 정보를 주기적으로 조회해, 은행 계좌 총 원장에 잔액을 변동시킴
    
    

## 레거시 코어뱅킹에 구현했다면?

![image.png](/assets/images/MSA/빅테크 기술 블로그/Toss/03-Next 코어뱅킹, MSA와 MySQL로 여는 평생 무료 환전 시대/image%206.png)



- 복잡한 은행 비즈니스 로직 간 의존성이 더욱 높아짐
- 모든 작업이 하나의 로컬 트랜잭션으로 묶여 동기적으로 처리돼 환전 속도가 느려짐


# 4️⃣ 외화예금 API 뜯어보기

## 동시성 제어

### **❓** 문제: 계좌 잔액 변동

- 원화 계좌에서 출금한 돈을 외화 계좌로 입금할 때 동시성 처리가 필요
    
    ![image.png](/assets/images/MSA/빅테크 기술 블로그/Toss/03-Next 코어뱅킹, MSA와 MySQL로 여는 평생 무료 환전 시대/image%207.png)
    
    - 환전을 하는 동시에 똑같은 계좌로 카드 결제가 들어올 수 있기 때문

### **❗** 해결책: Redis & DB Lock



- **애플리케이션 계층**: Redis:분산 락 사용
- **DB 계층**: 비관적 락 사용


![image.png](/assets/images/MSA/빅테크 기술 블로그/Toss/03-Next 코어뱅킹, MSA와 MySQL로 여는 평생 무료 환전 시대/image%208.png)

- 분산 락은 DB보다 빠른 응답 속도를 기대할 수 있어, 다른 트랜잭션에서 접근 시 Fail Fast 유도가 가능

## Latency 단축

### **❓** 문제: 동기적 검증으로 인한 시간 소요

- 입/출금 전에 계좌의 거래 가능 여부를 검증해야
    - 계좌가 해지된 상태는 아닌지, 명의도용된 계좌는 아닌지 등

- 레거시 코어뱅킹처럼 하나씩 동기적으로 검증하면, 검증 요소들이 너무 많아서 느림
    
    ![image.png](/assets/images/MSA/빅테크 기술 블로그/Toss/03-Next 코어뱅킹, MSA와 MySQL로 여는 평생 무료 환전 시대/image%209.png)
    

### **❗** 해결책: `Coroutine`

- 코루틴을 도입해, 동시간에 여러 검증을 수행하도록 함

## 고객과 관련 없는 사항 처리

### **❓** 문제: 너무 긴 전체 프로세스

- 고객과 관련 없이 은행 내부적으로 회계 처리를 위한 프로세스가 환전 속도를 저하

### **❗** 해결책: 고객과 관련 없는 것은 비동기적 처리

- 고객 계좌 잔액 수정 이후 은행 계좌 및 회계 처리를 위해 카프카 메시지를 발행
    
    ![image.png](/assets/images/MSA/빅테크 기술 블로그/Toss/03-Next 코어뱅킹, MSA와 MySQL로 여는 평생 무료 환전 시대/image%2010.png)
    

# 5️⃣ 24시간, 365일 무중단 환전 서비스 구현

## **❓** 문제: 잔액대사로 인한 자정 근방 거래 제한

- 기존 은행 시스템은 회계 시스템의 잔액대상 수행으로 인해, 매일 자정 근방에 거래가 불가능
    - 매일 자정에 모든 고객 계좌의 잔액의 총 합이 은행의 총 계좌의 잔액의 합과 동일한지 검증

- 기존 은행 시스템에서는 정확한 전일자 잔액 계산을 위해 다음 작업을 수행
    
    
    
    - 자정 근방에 모든 사용자들의 거래를 막음
        - 00시 00분 근방에 거래가 없었기 때문에, 정확한 잔액 산출이 가능
    - 모든 고객 계좌 잔액의 총합을 계산
    
    

- 하지만 고객들이 자정 근방에 거래할 수 없다는 치명적인 단점이 존재

## **❗** 해결책 (1): 데이터 보정



1. 00시 00분에 전일자 스냅샷 테이블을 생성
    - 이때도 거래가 계속 이루어지므로, 정확한 계산 값이 도출되지 않음
2. 00분 이후의 각 사용자의 첫번째 거래 내역을 확인하고 가져옴
3. 가져온 데이터로 잔액을 역산해, 전일자 스냅샷 테이블을 보정


## **❗** 해결책 (2): 잔액 기록 테이블



1. 거래 발생 일자, 계좌를 PK로 갖는 잔액 기록 테이블을 생성 
2. 금원 거래 발생 시, 발생 일자를 기준으로 해당 계좌의 잔액을 기록 
3. 전일자 스냅샷 테이블을 만들 때, 잔액 기록 테이블에서 일자를 기준으로 모든 계좌의 잔액을 가져옴


# 6️⃣ 100% 테스트 자동화

## 로컬 환경: 단위 테스트 작성

- 단위 테스트를 작성하고, 테스트가 1개라도 실패하면 빌드를 실패하도록 구현

## Dev 환경: E2E 서버 활용(업무 정합성 검증)

- E2E 서버에 배포 서버의 타깃이 되는 API 서버를 Dev 환경에서 호출하도록 코드를 작성
    - E2E 서버에 고객의 외화예금을 거래하는 것처럼 고객의 시나리오를 코드화하여 작성

- 코드 수정 사항 발생 시 E2E 테스트가 Trigger 되어, E2E 서버가 자동으로 수신 외화예금 서버 API를 호출해 업무의 정합성 검증

## Live 환경: 이상거래탐지 서비스 개발(데이터 완결성 검증)

- 이상거래탐지 서비스로 운영 환경에서 발생하면 안되는 데이터(해지된 계좌에서 발생한 거래, 하루에 이자를 2번 받은 계좌 등)가 발생했는지 검증
    - 데이터의 중요도에 따라 주기적으로 돌면서 알림을 주도록 설정

# 7️⃣ 전환 성과

- 금융권 최초로 MySQL 도입, MSA 기반의 안정적인 코어뱅킹 시스템을 구축
    - 1910만 MAU를 자랑하는 토스 홈에서 3000TPS 트래픽을 안정적으로 소화

- 세상에서 가장 빠른 환전 고객 경험 제공
    - 원화 송금 속도: 280ms, 외화 환전 속도: 30ms
    - MySQL, Redis 기반 캐싱, 코루틴 등의 신기술을 활용해 속도 최적화

- 24시간, 365일 잠들지 않는 무중단 환전/결제 고객 경험 제공
    - 원장 보정 작업도 MSA로 전환해, 고객에게 24시간 서비스 제공