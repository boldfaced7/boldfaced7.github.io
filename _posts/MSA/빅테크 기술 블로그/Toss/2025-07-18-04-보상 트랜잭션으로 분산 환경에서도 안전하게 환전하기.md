---
layout: single
title: "보상 트랜잭션으로 분산 환경에서도 안전하게 환전하기"
categories:
  - MSA
  - 빅테크 기술 블로그
  - Toss
tags:
  - MSA
  - 보상 트랜잭션
  - 분산 트랜잭션
  - SAGA 패턴
  - 환전 시스템
  - 토스뱅크
  - 마이크로서비스
toc: true
toc_sticky: true
---
<br>

>  **출처**: [**토스ㅣSLASH 24 - 보상 트랜잭션으로 분산 환경에서도 안전하게 환전하기**](https://www.youtube.com/watch?v=xpwRTu47fqY)

<br>

# 1️⃣ MSA 환전 서버 도입

## **❓ 문제: 모놀리틱 시스템의 한계**

- 시스템과 개발 규모가 커질수록 배포 및 개발 경험, 확장성, 단일 장애점 문제 발생

<br>

## **❗** 해결책: MSA

- 기존 코어 뱅킹 서버에 존재하던 로직을 조금씩 도메인별로 분리된 MSA 서버로 꺼내기
- 기존 코어 뱅킹 서버에 존재하지 않던 신규 상품은 DB까지 분리된 MSA 서버에 개발

<br>

## **❓** 문제: MSA의 복잡한 트랜잭션 보장 과정

- 모놀리틱 시스템이라면 환전 기능을 단순하게 구현할 수 있음
  
    ![image.png](/assets/images/MSA/빅테크 기술 블로그/Toss/04-보상 트랜잭션으로 분산 환경에서도 안전하게 환전하기/image.png)
    
- 하지만 MSA에서는 입/출금 중 하나가 실패하면 이전처럼 단순하게 트랜잭션을 수행할 수 없음
    - MSA 전환으로 외화 계좌와 원화 계좌 서버 및 DB가 분리된 상태이기 때문

<br>

## **❗** 해결책: 분산 트랜잭션

- 분산 트랜잭션을 구현해, 환전 원자성 보장해야
  
    ![image.png](/assets/images/MSA/빅테크 기술 블로그/Toss/04-보상 트랜잭션으로 분산 환경에서도 안전하게 환전하기/image%201.png)

<br>

## **↔️** 분산 트랜잭션 비교

### 1️⃣ **2PC(Two Phase Commit)**

#### 1단계: 투표

1. **Coordinator**: 커밋 가능 여부 질의
2. **트랜잭션 참여자**: 트랜잭션 열고 커밋 가능 여부 응답


![image.png](/assets/images/MSA/빅테크 기술 블로그/Toss/04-보상 트랜잭션으로 분산 환경에서도 안전하게 환전하기/image%202.png)



#### 2단계: 커밋

- **모든 참여자가 커밋 가능하다고 응답**: 트랜잭션 성공
  
    ![image.png](/assets/images/MSA/빅테크 기술 블로그/Toss/04-보상 트랜잭션으로 분산 환경에서도 안전하게 환전하기/image%203.png)
    
- **한 서비스라도 불가능 응답**: 커밋 롤백 요청 & 트랜잭션 실패
  
    ![image.png](/assets/images/MSA/빅테크 기술 블로그/Toss/04-보상 트랜잭션으로 분산 환경에서도 안전하게 환전하기/image%204.png)
    



### 2️⃣ **SAGA**

- 각 서비스들이 작은 로컬 트랜잭션에서 진행
- 특정 단계에서 실패시 보상 트랜잭션 처리

<br>

### 🔀 2PC vs SAGA

|  | 2PC | Saga |
| --- | --- | --- |
| 장점 | 강한 일관성 | 높은 가용성
높은 확장성 |
| 단점 | 낮은 가용성
낮은 확장성 | 중간 상태 노출
보상 트랜잭션 구현 필요 |

<br>

### ✅ Toss의 선택: SAGA

- 환전 서비스가 높은 트래픽을 견뎌야
- 다양한 트랜잭션 참여자(카드, 회계 등)가 추가될 수도

<br>



## **↔️ SAGA 패턴 구현 방식 비교**

### 1️⃣ Choreography Saga

- 중앙 제어자 없이 메세지 브로커 이용
  
    ![image.png](/assets/images/MSA/빅테크 기술 블로그/Toss/04-보상 트랜잭션으로 분산 환경에서도 안전하게 환전하기/image%205.png)
    

<br>

### 2️⃣ Orchestration Saga

- 오케스트레이터가 각 서비스들에게 트랜잭션과 보상 트랜잭션을 명령하면서 진행
  
    ![image.png](/assets/images/MSA/빅테크 기술 블로그/Toss/04-보상 트랜잭션으로 분산 환경에서도 안전하게 환전하기/image%206.png)
    

<br>

### 🔀 Choreography vs Orchestration

|  | Choreography Saga | Orchestration Saga |
| --- | --- | --- |
| 장점 | 중앙제어가 없으므로, 단일 장애점이 없고 각 서비스들이 느슨하게 결합 | 현재 진행중인 상태 추적 쉬움 |
| 단점 | 현재 진행중인 트랜잭션 상태 추적 및 디버깅 어려움 | 오케스트레이터가 단일 장애점이 됨
모든 서비스에게 결합됨 |

<br>

### ✅ Toss의 선택: Orchestration Saga

- 클라이언트 요청을 받아 환전을 시작하는 환전 서버가 필요
- 현재 진행 중인 환전 상태 관리 필요
    - 예) 환전 한도를 고려한 환전 구현 → 현재 진행중인 환전 금액 & 상태 추적 필요

- 환전 서버가 오케스트레이터가 됨
  
    ![image.png](/assets/images/MSA/빅테크 기술 블로그/Toss/04-보상 트랜잭션으로 분산 환경에서도 안전하게 환전하기/image%207.png)
    

<br>

# 2️⃣ 환전 서비스 구현

## **↔️ 환전에 사용할 2가지 통신 방식 비교**

### HTTP vs Messaging

| **HTTP** | **Messaging (Kafka)** |
| --- | --- |
| 동기 | 비동기 |
| 직관적, 비교적 구현이 간단 | 서비스 간 느슨한 결합 |
| 추가적인 에러 핸들링 필요 (5XX, timeout) | 메시지 브로커 레벨에서 에러 핸들링 |
| Client에서 read timeout 두기 편함 | 응답/timeout 구현 복잡 |



### **입/출금: `HTTP`**

- 입출금 결과를 알고 넘어가야(동기)
- 유저는 환전이 즉시 완료되기를 기대
- 환전 결과 지연 케이스에 대처하려면, 타임아웃 구현 필요
    - 비동기 메세징 기반 타임아웃 구현은 복잡도가 높음



### **원화 계좌 출금 취소(**보상 트랜잭션**): `Messaging`**

- 출금 취소는 환전의 마지막 과정
- 출금 취소는 비동기적으로 수행되어, 유저가 기다릴 필요가 없음
- 메세지 브로커와 원화 계좌 컨슈머에게 책임을 위임하여 결과적 정합성 보장
    - 출금 취소 에러 핸들링이 상대적으로 수월

<br>

## **⭕ 환전 성공**

### 원화 계좌 출금 성공

- 환전 서버가 원화 계좌 서버에 1,300원 출금을 요청하고, 출금 성공 응답을 전달 받음



### 외화 계좌 입금 성공

- 환전 서버가 외화 계좌 서버에 1달러 입금을 요청하고, 입금 성공 응답을 전달 받음



### 최종 성공

- 출금 성공 & 입금 성공이 모두 발생하면, 환전 성공
  
    ![image.png](/assets/images/MSA/빅테크 기술 블로그/Toss/04-보상 트랜잭션으로 분산 환경에서도 안전하게 환전하기/image%208.png)
    

<br>

## **❌ 환전 실패**

### 🔠 실패 종류

| 정상적인 실패 | 비정상적인 실패(에러) |
| --- | --- |
| 잔액 부족 | 서버 에러(5XX 응답, 타임아웃) |
| 잔액 증명서 출력 | 네트워크 에러 |
| 계좌 해지 | 메시지 Produce/Consume 실패 |
| 고객/계좌 거래 제한 |  |



### **⭕** 정상적인 실패

- **➡️ 출금 실패:** 추가적인 입금 요청 없이 환전 실패 처리 가능
- **⬅️ 입금 실패:** 출금 성공 후 입금 실패 시, 출금 취소 보상 트랜잭션 수행


![image.png](/assets/images/MSA/빅테크 기술 블로그/Toss/04-보상 트랜잭션으로 분산 환경에서도 안전하게 환전하기/image%209.png)



### **❌** 비정상적인 실패

- 서버 에러, 네트워크, 타임아웃
- 에러 핸들링 필요

<br>

## **❔ 왜 출금부터 처리할까?**

- Saga 패턴 사용 시, 중간 상태가 노출됨
- 입금부터 처리하면 환전 종료 이전에 다른 트랜잭션에서 입금된 금액을 출금해 갈 수 있음
  
    ![image.png](/assets/images/MSA/빅테크 기술 블로그/Toss/04-보상 트랜잭션으로 분산 환경에서도 안전하게 환전하기/image%2010.png)
    

<br>

# 3️⃣ 비정상적인 환전 실패가 발생한 경우

## **❓ 문제: 네트워크 에러로 인한 결과 확인 실패**

- 환전 서버가 원화 계좌 서버에 출금 요청 시, 서버 에러(5xx), 타임아웃
- 입출금은 성공했는데, 그 이후에 에러가 발생했거나, 지연되서 처리되었을 수도
    - 정상적인 실패와 동일하게 보기 어려움

<br>

## **❗** 해결책: 입출금 결과 다시 확인

### **➡️** 출금

- **출금 성공을 확인한 경우**: 보상 트랜잭션인 원화 계좌 출금 취소 처리
- **출금 실패를 확인한 경우**: 추가적인 처리 없이 환전 실패 처리


![image.png](/assets/images/MSA/빅테크 기술 블로그/Toss/04-보상 트랜잭션으로 분산 환경에서도 안전하게 환전하기/image%2011.png)



### **⬅️** 입금

- **입금 성공을 확인한 경우**: 환전 성공 처리
- **입금 실패를 확인한 경우**: 보상 트랜잭션인 원화 계좌 출금 취소 처리

![image.png](/assets/images/MSA/빅테크 기술 블로그/Toss/04-보상 트랜잭션으로 분산 환경에서도 안전하게 환전하기/image%2012.png)

<br>

## **❓ 문제: 원화/외화 계좌 서버 에러로 인한 결과 확인 실패**

- 원화/외화 계좌 서버 이슈나 네트워크 문제로 결과 확인 요청도 못하는 상황
  
    ![image.png](/assets/images/MSA/빅테크 기술 블로그/Toss/04-보상 트랜잭션으로 분산 환경에서도 안전하게 환전하기/image%2013.png)
    

<br>

## **❗** 해결책: Kafka Message Scheduler로 결과 확인 지연 처리

- **Kafka Message Scheduler**: 카프카 메시지를 지연시켜 발행할 수 있는 서버
  
    ![image.png](/assets/images/MSA/빅테크 기술 블로그/Toss/04-보상 트랜잭션으로 분산 환경에서도 안전하게 환전하기/image%2014.png)
    
    - 지연 시간이 지난 후, 원래 토픽 메세지를 대신 발행하도록 구현


<br>

- 프로듀서/컨슈머 모두 환전 서버라면, 특정 동작을 지연 시간만큼 뒤로 미루게 됨

    ![image.png](/assets/images/MSA/빅테크 기술 블로그/Toss/04-보상 트랜잭션으로 분산 환경에서도 안전하게 환전하기/image%2015.png)

    ![image.png](/assets/images/MSA/빅테크 기술 블로그/Toss/04-보상 트랜잭션으로 분산 환경에서도 안전하게 환전하기/image%2016.png)

    - 입/출금 계좌 서버에 회복할 시간을 줄 수 있음


<br>

- 환전 서버에서 원화 계좌 서버로 출금 결과 확인에 실패한 경우

      

    1. Kafka Message Scheduler로 30초 환전을 지연시킨 후, 출금 결과 확인 다시 시도
    2. 실패한 경우, 지연 시간을 늘려 다시 시도
    3. 정해진 횟수를 초과한 경우, 개발자가 문제 확인 후 직접 메세지를 발행해 출금 결과 확인


<br>

## **❓ 문제: 환전 서버 에러로** 결과 확인 지연 처리 **실패**

- 환전 서버의 문제로 환전 지연 이벤트를 발행하지 못하고 서버가 죽는 경우
    - 예) 장비 결함, Container OOM

<br>

## **❗** 해결책: 중간 상태 복구 & 배치 재처리

- 환전 서버(오케스트레이터)가 환전 트랜잭션의 마지막 상태를 가지고 있어, 중단된 상태부터 환전 재시작 가능
- 출금이 성공한 후 멈춰버린 환전의 경우, 배치가 출금 취소 메세지 발행한 후 환전 실패 처리
  
    ![image.png](/assets/images/MSA/빅테크 기술 블로그/Toss/04-보상 트랜잭션으로 분산 환경에서도 안전하게 환전하기/image%2017.png)
    

<br>

# 4️⃣ 원화 계좌 출금 취소 실패가 발생한 경우

## **❓** 문제: 원화 계좌 서버 에러로 원화 계좌 출금 취소 실패

- 외화 계좌 입금 실패 시, 원화 계좌에서 출금된 금액을 돌려줘야
- 원화 계좌 출금 취소를 처리하다가 에러가 발생하면, 데이터 정합성에 문제가 발생
  
    ![image.png](/assets/images/MSA/빅테크 기술 블로그/Toss/04-보상 트랜잭션으로 분산 환경에서도 안전하게 환전하기/image%2018.png)
    

<br>

## **❗ 해결책: CDL로 Eventually Consistency 확보**



1. **환전 서버**: 출금 취소 메시지를 발행해, **서비스 메시지 브로커로** 전달
2. **원화 계좌**: **취소 처리 중 에러가 발생**하는 경우, **CDL 메세지 브로커로** 메시지 전달
3. **CDL 메세지 브로커**: 전달 받은 메시지를 **DL 서버로** 전달
4. **DL 서버**: 정해진 재시도 횟수/간격으로 **서비스 메세지 브로커로** 메세지 전달
5. **원화 계좌 서버**: 출금 취소 재시도
6. **정해진 횟수를 모두 실패**한 경우, 개발자가 DL 서버를 통해 다시 메세지 발행 가능


![image.png](/assets/images/MSA/빅테크 기술 블로그/Toss/04-보상 트랜잭션으로 분산 환경에서도 안전하게 환전하기/image%2019.png)

![image.png](/assets/images/MSA/빅테크 기술 블로그/Toss/04-보상 트랜잭션으로 분산 환경에서도 안전하게 환전하기/image%2020.png)

<br>

## **❓** 문제: 서비스 메시지 브로커 에러로 원화 계좌 출금 취소 실패

- Saga에서는 Local Transaction commit과 message 발행이 원자적으로 이루어져야
    - 즉, **입금 실패로 인한 환전 실패 처리**와 **출금 취소 메세지 발행**은 **항상 같이** 이루어져야

- 그런데, 서비스 메세지 브로커 장애로 메세지 발행 자체가 안 될 수도
  
    ![image.png](/assets/images/MSA/빅테크 기술 블로그/Toss/04-보상 트랜잭션으로 분산 환경에서도 안전하게 환전하기/image%2021.png)

<br>

## **❗ 해결책: PDL로 Transactional Messaging 확보**



1. **환전 서버**: 출금 취소 메시지를 발행해, **서비스 메시지 브로커로** 전달
2. **서비스 메시지 브로커**: 메시지 전달 실패
3. **환전 서버**: 발행한 출금 취소 메시지를 **PDL 메시지 브로커**로 전달
4. **PDL 메세지 브로커**: 전달 받은 메시지를 **DL 서버로** 전달
5. **DL 서버:** 일정 시간이 지난 후, 회복된 서비스 메세지 브로커로 메세지를 전달


![image.png](/assets/images/MSA/빅테크 기술 블로그/Toss/04-보상 트랜잭션으로 분산 환경에서도 안전하게 환전하기/image%2022.png)

![image.png](/assets/images/MSA/빅테크 기술 블로그/Toss/04-보상 트랜잭션으로 분산 환경에서도 안전하게 환전하기/image%2023.png)

<br>

# 5️⃣ 모니터링

## **🔎** 환전 서버에서 환전 지연 모니터링

### **상태 머신(State Machine)**

- Orchestration Saga는 각 트랜잭션 상태별 명령이 정해져 있어, 상태 머신으로 나타낼 수 있음
  
    ![image.png](/assets/images/MSA/빅테크 기술 블로그/Toss/04-보상 트랜잭션으로 분산 환경에서도 안전하게 환전하기/image%2024.png)
    



### **상태 경로(State Path)**

- `exchange_request` 테이블: 환율, 환전 금액 등 환전 요청이 스냅샷 형태로 저장됨
  
    ![image.png](/assets/images/MSA/빅테크 기술 블로그/Toss/04-보상 트랜잭션으로 분산 환경에서도 안전하게 환전하기/image%2025.png)
    
- `exchange_state_log` 테이블: 환전이 거쳐가는 상태를 저장
  
    ![image.png](/assets/images/MSA/빅테크 기술 블로그/Toss/04-보상 트랜잭션으로 분산 환경에서도 안전하게 환전하기/image%2026.png)
    
- 두 테이블을 이용해, 환전이 거처간 모든 상태 경로 확인이 가능
- 예를 들어, 여러 가지 환전 실패 케이스 구분이 가능
    - 외화 출금 실패로 실패한 환전
      
        ![image.png](/assets/images/MSA/빅테크 기술 블로그/Toss/04-보상 트랜잭션으로 분산 환경에서도 안전하게 환전하기/image%2027.png)
        
    - 원화 입금 실패로 실패한 환전
      
        ![image.png](/assets/images/MSA/빅테크 기술 블로그/Toss/04-보상 트랜잭션으로 분산 환경에서도 안전하게 환전하기/image%2028.png)
        
    



### **환전 경로 모니터링**

- 환전 서버가 모든 환전 상태를 관리해, 일정 기간 이후에도 끝나지 않은 환전 탐지가 가능
    - 해당 사항을 개발자들에게 Alert

![image.png](/assets/images/MSA/빅테크 기술 블로그/Toss/04-보상 트랜잭션으로 분산 환경에서도 안전하게 환전하기/image%2029.png)

<br>

## 🔬 **배치 서버에서 입출금 최종 정합성 확인**

- 입금(원화 계좌)/출금(외화 계좌) 쌍을 맞춰 환전의 최종 정합성을 확인해야



- **각 서버**: 입/출금 내역 중 하나만 저장하므로, ETL을 통해 분석용 DB에 주기적으로 적재
- **배치 서버**: 분석용 DB에서 입출금 키로 쌍이 맞는지 지속적으로 확인


![image.png](/assets/images/MSA/빅테크 기술 블로그/Toss/04-보상 트랜잭션으로 분산 환경에서도 안전하게 환전하기/image%2030.png)

<br>

# 6️⃣ 결론 및 성과

## **1. 또 다른 Saga**

- Saga 패턴의 장점인 확장성을 통해 추가 기능을 쉽게 구현 가능



### 회계

- 토스에서는 매일 발생하는 입/출금을 기록하여 회계 처리 필요
- 원화 계좌 서버와 외화 계좌 서버가 메세지 발행하는 방식으로 쉽게 확장 가능
    - 회계 서버가 환전 트랜잭션의 참여자로 추가되는 것
    
    ![image.png](/assets/images/MSA/빅테크 기술 블로그/Toss/04-보상 트랜잭션으로 분산 환경에서도 안전하게 환전하기/image%2031.png)
    
- 2PC로 구현할 경우 다음 문제가 발생
  
    
  
    - 가용성 및 성능 문제
    - 서비스 간 강결합 문제
        - 원화/외화 계좌 서버가 트랜잭션을 열고 회계 서버의 투표까지 기다려야
        - 회계 서버 장애 발생 시 유저가 환전을 못함
    
    

### **부족한 돈 자동 환전 결제**

- 카드 결제 시 외화가 부족한 경우, 실시간 환율로 환전해 결제하는 서비스 도입
- 카드 서버가 환전 Saga를 이용해 쉽게 확장 가능
  
    ![image.png](/assets/images/MSA/빅테크 기술 블로그/Toss/04-보상 트랜잭션으로 분산 환경에서도 안전하게 환전하기/image%2032.png)
    

<br>

## **2. Trade Off**

| Pros | Cons |
| --- | --- |
| MSA 전환으로 기존 계정계 시스템의 문제 해결 | 트랜잭션 구현 복잡도 증가 |
| 계정계 시스템과의 느슨한 결합, 확장 가능한 구조 |  |

<br>

## **3. 성과**



- 외화 예금을 MSA 서버에 구축하면서 분산 환경 생성
- SAGA를 사용해 높은 가용성을 유지하면서도 분산 트랜잭션 보장
- 계좌 입출금 서버에 문제가 생겨도 자동으로 회복
- 기존 계정계 시스템과 연결 및 확장 가능한 구조 확보
- 출시 후 3개월간 약 100만 계좌 개설
- 5조 2천억 가량의 거래량 소화

<br>

# **7️⃣ Transactional Messaging 관련 Q&A**

- **내부적으로 메시징 발행 재처리가 DL 중심으로 잡혀 있는가?**
    - 토스뱅크는 모든 토픽에 대해 기본적으로 PDL이 적용됨
    - 따라서 추가적인 아웃박스 패턴 등을 적용하지 않음

<br>

- **DL 서버에서 메시지 발행에 실패하면 어떻게 되는가?**
    - DL 서버의 PDL 메시지 처리도 컨슈머로 동작하므로, CDL을 이용해 재처리 가능
        - 메시지 브로커 간 발행 실패 또는 DLQ 처리 실패 발생에 대한 해결 방법이 추가로 필요

<br>

- **아웃박스 패턴이 아닌 PDL을 사용하는 경우, 개발 복잡도가 증가하는 것 아닌가?**
    - 아웃박스 패턴 사용 시, 각 서비스 DB에 아웃박스 테이블이 필요
    - 토스뱅크는 수백 개의 MSA 서버가 독립된 스키마를 사용하며, 다양한 DB와 수십 개의 물리 서버에 그룹화되어 있어 일괄 적용이 어려움
    - 반면 PDL은 모든 서버에서 동일한 메시지 브로커를 바라봐, 라이브러리 형태로 제공되어 일괄 적용이 편리

<br>

- **PDL 메시지 브로커의 고가용성이 보장되지 않으면, 불필요한 인프라 비용이 발생하는 것 아닌가?**
    - PDL 메시지 브로커로 서버에서 로그를 남길 때 사용하는 로그 Kafka 클러스터를 사용
    - 즉 고가용성을 위한 세팅이 적용되어 있으며 평상시에도 항상 사용하고 있음
    - 따라서, PDL 메시지가 발행되지 않아도 메시지 브로커에 문제가 생기면 그 즉시 알게 됨