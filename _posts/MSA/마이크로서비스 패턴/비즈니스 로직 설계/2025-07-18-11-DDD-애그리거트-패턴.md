---
layout: single
title: "2. DDD 애그리거트 패턴"
categories:
  - MSA
  - 마이크로서비스 패턴
  - 비즈니스 로직 설계
  
tags:
  - DDD
  - 애그리거트
  - 도메인 모델
  - 트랜잭션
  - MSA
  - NoSQL
  - 사가
  
toc: true
toc_sticky: true
---

# 1. 전통적인 도메인 모델: 경계가 불분명

## 0. 사례

![20241128_141036.png](/assets/images/MSA/마이크로서비스 패턴/비즈니스 로직 설계/11-DDD-애그리거트-패턴/20241128_141036.png)

## 1. 개념적으로 모호함

- 비즈니스 객체가 정확히 무슨 작업을 하고, 그 범위는 어디까지인지 알기가 어려움
    - 어느 클래스가 Order라는 비즈니스 객체의 일부인지 분명하지 않음

## 2. 비즈니스 규칙 위반 야기

- 각 비즈니스 객체가 준수해야 할 비즈니스 규칙을 어디까지 적용해야 할지 파악하기 어려워, 애매한 경계에서 비즈니스 규칙을 위반할수도

# 2. 애그리거트: 경계가 분명

## 0. 애그리거트란?

- 한 단위로 취급 가능한 경계 내부의 도메인 객체들
    - 하나의 루트 엔티티, 하나 이상의 기타 엔티티, 밸류 객체로 구성됨
    - 도메인 모델을 개별적으로 이해하기 쉬운 덩어리로 분해해, 작업 범위를 분명하게 설정
    
    ![20241128_141056.png](/assets/images/MSA/마이크로서비스 패턴/비즈니스 로직 설계/11-DDD-애그리거트-패턴/20241128_141056.png)
    

- 로드, 수정, 삭제 작업은 전체 애그리거트에 작용되어, 일관성 문제가 해소됨

## 1. 애그리거트는 일관된 경계

- 업데이트 작업은 애그리거트 루트에서 호출되어, 불변 값이 강제됨
- 동시성 작업은 애그리거트 루트를 버전 번호 또는 DB 수준 락으로 잠금하여 처리

## 2. 애그리거트를 식별하는 일이 관건

- DDD 도메인 모델 설계의 핵심은 애그리거트, 경계, 루트를 식별하는 것

# 3. 애그리거트 규칙

## 1. 애그리거트 루트만 참조하라

- 클라이언트는 애그리거트 루트 메서드만 호출해 애그리거트 업데이트가 가능
- 따라서 애그리거트는 불변 값을 강제할 수 있게 됨

## 2. 애그리거트 간 참조는 반드시 기본키를 사용하라

- 애그리거트는 객체 레퍼런스 대신 기본키로 서로를 참조해야
    
    ![20241128_141117.png](/assets/images/MSA/마이크로서비스 패턴/비즈니스 로직 설계/11-DDD-애그리거트-패턴/20241128_141117.png)
    
- 따라서 애그리거트는 느슨하게 결합되고 애그리거트 간 경계가 분명해짐
- 또한 그 자체가 저장 단위이므로, 저장 로직도 간단해짐

## 3. 하나의 트랜잭션으로 하나의 애그리거트를 생성/수정하라

- 하나의 트랜잭션으로 하나의 애그리거트만 생성/수정하는 것은 MSA와 NoSQL에 적합
- 여러 애그리거트를 생성/수정하는 작업을 구현하기가 조금 복잡해지나, 이는 사가로 해결 가능
    
    ![20241128_141133.png](/assets/images/MSA/마이크로서비스 패턴/비즈니스 로직 설계/11-DDD-애그리거트-패턴/20241128_141133.png)
    

# 4. 애그리거트 크기

- 애그리거트는 작으면 작을수록 동시 처리 가능 요청 개수가 늘고 확장성이 좋아짐
- 하지만 애그리거트 자체가 트랜잭션 범위라, 어떤 업데이트를 원자적으로 처리하려면 애그리거트를 크게 잡아야할 수도
    - `Consumer` 애그리거트를 다음처럼 구성하면, `Order`와 `Consumer`의 업데이트를 원자적으로 처리 가능
    - 하지만 확장성이 떨어지고, 두 사용자가 동일 고객의 상이한 주문을 고치려고 하면 충돌이 발생
    
    ![20241128_150756.png](/assets/images/MSA/마이크로서비스 패턴/비즈니스 로직 설계/11-DDD-애그리거트-패턴/20241128_150756.png)
    

- 큰 애그리거트는 MSA에서 분해의 걸림돌이므로, 가급적 잘게 나누기로

# 5. 비즈니스 로직 설계: 애그리거트



- **사가**: 로컬 트랜잭션을 오케스트레이션해, 데이터 일관성을 맞춤
- **인바운드 어댑터**: 비즈니스 로직의 진입접인 서비스를 호출
- **서비스**: 리포지터리로 애그리거트를 조회/저장
- **리포지터리**: DB에 접근하는 아웃바운드 어댑터로 구현


![20241128_150819.png](/assets/images/MSA/마이크로서비스 패턴/비즈니스 로직 설계/11-DDD-애그리거트-패턴/20241128_150819.png)