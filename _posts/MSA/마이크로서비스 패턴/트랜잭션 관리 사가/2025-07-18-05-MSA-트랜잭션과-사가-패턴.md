---
layout: single
title: "1. MSA 트랜잭션과 사가 패턴"
categories:
  - MSA
  - 마이크로서비스 패턴
  - "트랜잭션 관리: 사가"
tags:
  - MSA
  - 분산트랜잭션
  - 사가패턴
  - 보상트랜잭션
toc: true
toc_sticky: true
---
# 1. 분산 트랜잭션

## 1. 분산 트랜잭션의 필요성

### 모놀리식 아키텍처와 트랜잭션

- ACID 트랜잭션을 이용해 연산에 필요한 데이터를 가져오면 됨

### 마이크로서비스 아키텍처와 트랜잭션

- MSA에서는 데이터 일관성을 보장하며 여러 서비스의 데이터에 접근하는 것이 어려움
    - 데이터가 여러 서비스에 흩어져 있기 때문
    
    ![image.png](/assets/images/MSA/마이크로서비스 패턴/트랜잭션 관리: 사가/05-MSA-트랜잭션과-사가-패턴/image.png)
    

## 2. 분산 트랜잭션의 문제점



- **분산 트랜잭션 지원 여부**: NoSQL DB와 현대 메시지 브로커는 분산 트랜잭션을 지원하지 않음
- **가용성 문제**: 분산 트랜잭션은 동기 IPC 형태라 가용성이 떨어짐


# 2. 데이터 일관성 유지: 사가 패턴

## 1. 사가 패턴이란?

- 비동기 메시징을 이용해 편성한 일련의 로컬 트랜잭션
    - 여러 서비스의 데이터를 업데이트하는 시스템 커맨드마다 사가를 정의
    - 로컬 트랜잭션이 단계별로 편성되어 있어, 한 트랜잭션이 끝나면 다른 트랜잭션이 실행됨
    - 비동기 메시징을 이용해, 사가 참여자가 일시 불능 상태여도 전체 단계 실행이 가능

- 사가에는 AICD 트랜잭션에 있는 격리성이 없음
- 로컬 트랜잭션마다 변경분을 커밋해, 보상 트랜잭션을 걸어 롤백해야

## 2. 예제: 주문 생성 사가

### **작동 원리**

- 서비스는 외부 요청을 받아 작업을 수행하고, 로컬 트랜잭션이 완료되면 메시지를 발행해 다음 사가 단계를 트리거
    - 메시지를 통해 사가 참여자를 느슨하게 결합하고, 사가가 반드시 완료되도록 보장

- 메시지 수신자가 일시 불능 상태면, 메시지 브로커는 메시지 전달이 가능할 때까지 메시지를 버퍼링

### **`createOrder()`의 사가**

![image.png](/assets/images/MSA/마이크로서비스 패턴/트랜잭션 관리: 사가/05-MSA-트랜잭션과-사가-패턴/image%201.png)



1. **주문 서비스**: 주문을 `APPROVAL_PENDING` 상태로 생성
2. **소비자 서비스**: 주문 가능한 소비자인지 확인
3. **주방 서비스**: 주문 내역을 확인하고, 티켓을 `CREATE_PENDING` 상태로 생성
4. **회계 서비스**: 소비자 신용카드 승인
5. **주방 서비스**: 티켓 상태를 `AWAITING_ACCEPTANCE` 상태로 변경
6. **주문 서비스**: 주문 상태를 `APPROVED` 상태로 변경


## 3. 사가는 보상 트랜잭션으로 변경분을 롤백한다

### ACID 트랜잭션의 롤백

비즈니스 로직 실행 중 규칙에 위배되는 경우, DB에서 롤백을 수행

### 사가 패턴의 롤백

- 단계마다 로컬 DB에 변경분을 커밋해, 자동 롤백이 불가능
- 따라서 보상 트랜잭션을 미리 작성해야

### **보상 트랜잭션이란?**

- (N+1)번째 사가 트랜잭션이 실패하면, 이전 N개의 트랜잭션을 undo
    - 보상 트랜잭션은 트랜잭션 진행의 반대 방향으로 실행됨
    
    ![image.png](/assets/images/MSA/마이크로서비스 패턴/트랜잭션 관리: 사가/05-MSA-트랜잭션과-사가-패턴/image%202.png)
    

### **주문 생성 사가의 보상 트랜잭션**

- 주문 생성 사가가 실패하는 이유는 다음과 같음
    
    
    
    - 소비자 정보가 올바르지 않거나, 주문을 할 수 없는 소비자
    - 음식점 정보가 올바르지 않거나, 주문 접수가 불가능한 음식점
    - 소비자 신용카드가 승인 거절됨
    
    

- 로컬 트랜잭션이 실패하면, 사가는 주문, 티켓을 무효화하는 보상 트랜잭션을 수행해야
    
    
    | 단계 | 서비스 | 트랜잭션 | 보상 트랜잭션 |
    | --- | --- | --- | --- |
    | 1 | 주문 서비스 | `createOrder()` | `rejectOrder()` |
    | 2 | 소비자 서비스 | `verifyConsumerDetails()` | - |
    | 3 | 주방 서비스 | `createTicket()` | `rejectTicket()` |
    | 4 | 회계 서비스 | `authorizeCreditCard()` | - |
    | 5 | 주방 서비스 | `approveTicket()` | - |
    | 6 | 주문 서비스 | `approveOrder()` | - |
    
    
    
    - **보상 가능 트랜잭션**: 실패할 가능성이 있는 단계(1-3)
    - **피봇 트랜잭션**: 절대로 실패하지 않는 단계의 다음 단계(4)
    - **재시도 가능 트랜잭션**: 항상 성공하는 단계(5-6)
    
    
    - 읽기 전용 단계나 항상 성공하는 단계 다음 단계는 보상 트랜잭션이 필요 없음

- 소비자 신용카드 승인이 실패하는 경우, 보상 트랜잭션은 다음 순서로 작동
    
    
    
    1. **주문 서비스**: 주문을 `APPROVAL_PENDING` 상태로 생성
    2. **소비자 서비스**: 주문 가능한 소비자인지 확인
    3. **주방 서비스**: 주문 내역을 확인하고, 티켓을 `CREATE_PENDING` 상태로 생성
    4. **회계 서비스**: 소비자 신용카드 승인 요청이 거부됨
    5. **주방 서비스**: 티켓 상태를 `CREATE_REJECTED` 상태로 변경
    6. **주문 서비스**: 주문 상태를 `REJECT` 상태로 변경
