---
layout: single
title: "2. 사가 편성 방법"
categories:
  - MSA
  - 마이크로서비스 패턴
  - "트랜잭션 관리: 사가"
tags:
  - MSA
  - 사가편성
  - 코레오그래피
  - 오케스트레이션
toc: true
toc_sticky: true
---
# 1. 코레오그래피 사가

## 1. 코레오그래피 사가란?

- 중앙 편성자가 없어, 의사 결정, 순서화를 사가 참여자가 수행
- 각 참여자는 자신의 DB를 업데이트하고, 다음 참여자를 트리거하는 이벤트를 발행

## 2. 주문 생성 사가 구현: 코레오그래피 스타일

### **주문 성공**

![image.png](/assets/images/MSA/마이크로서비스 패턴/트랜잭션 관리: 사가/06-사가-편성-방법/image.png)



1. **주문 서비스: `createOrder()`**
    1. 주문을 `APPROVAL_PENDING` 상태로 생성
    2. 주문 생성 이벤트 발행

1. **소비자 서비스: `verifyConsumerDetails()`**
    1. 주문 생성 이벤트 수신
    2. 주문 가능한 소비자인지 확인
    3. 소비자 확인 이벤트 발행

1. **주방 서비스: `createTicket()`**
    1. 주문 생성 이벤트 수신
    2. 주문 내역을 확인
    3. 티켓을 `CREATE_PENDING` 상태로 생성
    4. 티켓 생성됨 이벤트 발행

1. **회계 서비스: `createPendingAuthorization()`**
    1. 주문 생성 이벤트 수신
    2. 신용카드 승인을 `PENDING` 상태로 생성

1. **회계 서비스: `authorizeCard()`**
    1. 티켓 생성 및 소비자 확인 이벤트 수신
    2. 소비자 신용카드 과금
    3. 신용카드 승인 이벤트 발행

1. **주방 서비스: `approveTicket()`**
    1. 신용카드 승인됨 이벤트 수신
    2. 티켓 상태를 `AWAITING_ACCEPTANCE` 상태로 변경

1. **주문 서비스: `approveOrder()`**
    1. 신용카드 승인됨 이벤트 수신
    2. 주문 상태를 `APPROVED` 상태로 변경
    3. 주문 승인됨 이벤트 발행


### **주문 실패**

![image.png](/assets/images/MSA/마이크로서비스 패턴/트랜잭션 관리: 사가/06-사가-편성-방법/image%201.png)



1. **주문 서비스: `createOrder()`**
    1. 주문을 `APPROVAL_PENDING` 상태로 생성
    2. 주문 생성 이벤트 발행

1. **소비자 서비스: `verifyConsumerDetails()`**
    1. 주문 생성 이벤트 수신
    2. 주문 가능한 소비자인지 확인
    3. 소비자 확인 이벤트 발행

1. **주방 서비스: `createTicket()`**
    1. 주문 생성 이벤트 수신
    2. 주문 내역을 확인
    3. 티켓을 `CREATE_PENDING` 상태로 생성
    4. 티켓 생성됨 이벤트 발행

1. **회계 서비스: `createPendingAuthorization()`**
    1. 주문 생성 이벤트 수신
    2. 신용카드 승인을 `PENDING` 상태로 생성

1. **회계 서비스: `authorizeCard()`**
    1. 티켓 생성 및 소비자 확인 이벤트 수신
    2. 소비자 신용카드 과금
    3. **신용카드 승인 실패 이벤트 발행**

1. **주방 서비스: `rejectTicket()`**
    1. 신용카드 승인 실패 이벤트 수신
    2. 티켓 상태를 `REJECT` 상태로 변경

1. **주문 서비스: `rejectOrder()`**
    1. 신용카드 승인됨 이벤트 수신
    2. 주문 상태를 `REJECT` 상태로 변경
    3. 주문 승인됨 이벤트 발행


## 3. 확실한 이벤트 기반 통신

- 코레오그래피 방식으로 사가를 구현하려면, 다음 두 가지 통신 이슈를 고려해야

### **트랜잭셔널 매니징**

- DB 업데이트 작업과 이벤트 발행 작업은 원자적으로 일어나야
- 따라서 사가 참여자가 서로 확실하게 통신하려면 트랜잭셔널 매니징을 사용해야

### **이멘트-데이터 매핑**

- 사가 참여자는 수신한 이벤트와 자신이 가진 데이터를 연관 지을 수 있어야
    - 신용카드 승인 이벤트를 받은 주문 서비스는, 여기에 해당하는 주문을 찾을 수 있어야

- 보통 다른 사가 참여자가 상관 관계 ID가 포함된 이벤트를 발행
    - 회계 서비스는 `orderId`를 상관 관계 ID로 삼아 다른 참여자에게 건내줌
    - 신용카드 승인 이벤트를 받은 주문 서비스는, `orderId`로 주문을 찾을 수 있음

## 4. 코레오그래피 사가의 장점



- **단순함**: 비지니스 객체 생성/수정/삭제 시 서비스가 이벤트를 발행
- **느슨한 결합**: 참여자는 이벤트를 구독할 뿐, 서로를 직접 알지는 못함


## 5. 코레오그래피 사가의 단점



- **이해하기 어려움**: 여러 서비스에 구현 로직이 흩어져 있어, 어떤 사가가 어떻게 작동하는지 이해하기 어려움
- **서비스 간 순환 의존성:** 참여자가 서로 이벤트를 구독해, 순환 의존성이 발생하기 쉬움
    - 반드시 문제라고 할 수는 없지만, 잠재적인 설계 취약점
- **단단히 결합될 위험성**: 사가 참여자는 각자 자신에게 영향을 미치는 이벤트를 모두 구독해야


- 간단한 사가라면 코레오그래피 방식으로도 충분하나, 복잡한 사가에는 사용하기 어려움

# 2. 오케스트레이션 사가

## 1. 오케스트레이션 사가란?

- 사가 편성 로직을 사가 오케스트레이터에 중앙화
    
    
    
    1. **사가 오케스트레이터**: 비동기적으로 사가 참여자에게 커맨드 메시지를 보내 수행 작업 지시
    2. **사가 참여자**: 작업을 마치고 응답 메시지를 오케스트레이터에게 전달
    3. **사가 오케스트레이터**: 응답 메시지 처리 후 다음 사가 단계를 수행
    
    

## 2. 주문 생성 사가 구현: 오케스트레이션 스타일

![image.png](/assets/images/MSA/마이크로서비스 패턴/트랜잭션 관리: 사가/06-사가-편성-방법/image%202.png)



1. **사가 오케스트레이터**: 소비자 확인 커맨드를 소비자 서비스에 전송
2. **소비자 서비스**: 소비자 확인 메시지를 응답

1. **사가 오케스트레이터**: 티켓 생성 커맨드를 주방 서비스에 전송
2. **주방 서비스**: 티켓 생성 메시지를 응답

1. **사가 오케스트레이터**: 신용카드 승인 메시지를 회계 서비스에 전송
2. **회계 서비스**: 신용카드 승인됨 메시지를 응답

1. **사가 오케스트레이터**: 티켓 승인 커맨드를 주방 서비스에 전송
2. **사가 오케스트레이터**: 주문 승인 커맨드를 주문 서비스에 전송


## 3. 사가 오케스트레이터를 상태 기계로 모델링

### **상태 기계란?**

- 주문 생성 사가의 경우, 크게 4가지 시나리오를 생각해볼 수 있음
    
    
    
    - 정상 케이스
    - 소비자 서비스 오류
    - 주방 서비스 오류
    - 회계 서비스 오류
    
    
- 따라서 가능한 모든 시나리오를 기술하는 상태 기계로 사가를 모델링하면 유용

- 상태 기계는 상태, 이벤트에 의해 트리거되는 상태 전이로 구성됨
    - 전이가 발생할 때마다 일어나는 액션이 사가 참여자를 호출
    - 상태 전이는 사가 참여자가 로컬 트랜잭션을 완료하는 시점에 트리거됨
    - 로컬 트랜잭션의 상태/결과에 따라 상태 전이를 어떻게 하고, 어떤 액션을 취할지 결정

- 상태 기계는 다양한 상태 전이를 정의
    - 주문 생성 사가의 상태 기계는 티켓 생성 상태 → 신용카드 승인 또는 거부 상태로 전이

### **상태 기계로 모델링한 주문 생성 사가**

![image.png](/assets/images/MSA/마이크로서비스 패턴/트랜잭션 관리: 사가/06-사가-편성-방법/image%203.png)



- **소비자 확인**: 초기 상태, 사가는 소비자 서비스가 주문 가능한 소비자인지 확인할 때까지 기다림
- **티켓 생성**: 사가는 티켓 생성 커맨드에 대한 응답을 기다림
- **신용카드 승인**: 회계 서비스가 소비자 신용카드를 승인할 때까지 기다림
- **주문 승인됨**: 사가가 성공적으로 완료되었음을 나타내는 최종 상태
- **주문 거부됨**: 참여자 중 하나가 주문을 거부했음을 나타내는 최종 상태


- 상태 기계는 사가 참여자의 여러 가지 응답에 따라 다양한 상태 전이를 거치며, 주문 승인/거부 중 한 쪽으로 귀결됨