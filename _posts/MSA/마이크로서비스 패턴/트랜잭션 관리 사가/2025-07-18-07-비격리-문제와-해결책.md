---
layout: single
title: "3. 비격리 문제와 해결책"
categories:
  - MSA
  - 마이크로서비스 패턴
  - "트랜잭션 관리: 사가"
tags:
  - MSA
  - 비격리
  - 시맨틱락
  - 교환적업데이트
toc: true
toc_sticky: true
---
# 0. 사가와 격리성

- **격리성**: 동시에 실행된 트랜잭션의 결과가 임의의 순서대로 실행된 결과와 동일함을 보장하는 속성

- 사가는 격리성을 보장하지 못해, 사가의 한 트랜잭션이 커밋한 변경분을 다른 사가가 즉시 볼 수도
    
    
    
    - 한 사가가 실행 중 접근하는 데이터를 다른 사가가 바꿔치기할 수도
    - 한 사가가 업데이트를 하기 전 데이터를 다른 사가가 읽을 수도
    
    
    - 사가는 사실상 ACD(Atomicity, Consistency, Duarbility) 트랜잭션으로 보아야

- 격리가 안되면 비정상이 나타나, 동시 실행 결과와 순차 실행 결과가 달라질 수도
- 비격리가 용납 불가능한 문제처럼 보이긴 하나, 성능 향상을 위해 격리 수준을 낮추는 경우가 흔함
    - RDBMS는 격리 수준을 트랜잭션마다 다르게 지정할 수 있음
    - 또한 기본적으로 완전 격리보다는 약한 격리 수준을 적용

# 1. 비정상 문제

## 1. 소실된 업데이트

- 한 사가의 변경분을 다른 사가가 미처 못 읽고 덮어 씀
    
    
    
    1. **주문 생성 사가**: 첫 단계에서 주문을 생성
    2. **주문 취소 사가**: 주문 생성 사가 실행 중에 주문을 취소
    3. **주문 생성 사가**: 마지막 단계에서 주문을 승인
    4. **고객**: 주문 취소한 음식을 배달 받음
    
    

## 2. 더티 읽기

- 한 사가가 업데이트 중인 데이터를 다른 사가가 읽는 것

- 주문 취소 사가는 다음과 같은 트랜잭션으로 구성됨
    
    
    
    1. **소비자 서비스**: 신용 잔고를 늘림
    2. **주문 서비스**: 주문을 취소 상태로 변경
    3. **배달 서비스**: 배달을 취소
    
    

- 주문 취소/생성 사가의 실행이 겹친 상황에서, 주문 취소 사가가 롤백되면, 다음처럼 트랜잭션 순서가 엉킬 수도
    
    
    
    1. **주문 취소 사가**: 신용 잔고를 늘림
    2. **주문 생성 사가**: 신용 잔고를 줄임
    3. **주문 취소 사가**: 신용 잔고를 줄이는 보상 트랜잭션을 가동
    4. **소비자**: 신용 한도를 초과하는 주문을 수행할 수 있게 됨
    
    

## 3. 퍼지/반복 불가능한 읽기

- 한 사가의 상이한 두 단계가 같은 데이터를 읽어도 결과가 달라짐
    - 그 사이에 다른 사가가 업데이트를 했기 때문

# 2. 사가의 구조

## 1. 사가 트랜잭션 종류



- **보상 가능 트랜잭션**: 보상 트랜잭션으로 롤백이 가능해야 하는 트랜잭션
- **피봇 트랜잭션**: 사가의 진행/중단 지점으로, 성공 시 사가는 완료될 때까지 실행
    - 피봇 트랜잭션은 최종 보상 가능 트랜잭션, 최소 재시도 가능 트랜잭션이 될 수 있음

- **재시도 가능 트랜잭션**: 피봇 트랜잭션 직후의 트랜잭션으로, 완료가 보장됨


![image.png](/assets/images/MSA/마이크로서비스 패턴/트랜잭션 관리: 사가/07-비격리-문제와-해결책/image.png)

## 2. 주문 생성 사가 사례

| 단계 | 서비스 | 트랜잭션 | 보상 트랜잭션 | 트랜잭션 종류 |
| --- | --- | --- | --- | --- |
| 1 | 주문 서비스 | `createOrder()` | `rejectOrder()` | 보상 가능 |
| 2 | 소비자 서비스 | `verifyConsumerDetails()` | - | - |
| 3 | 주방 서비스 | `createTicket()` | `rejectTicket()` | 보상 가능 |
| 4 | 회계 서비스 | `authorizeCreditCard()` | - | 피봇 |
| 5 | 주방 서비스 | `approveTicket()` | - | 재시도 가능 |
| 6 | 주문 서비스 | `approveOrder()` | - | 재시도 가능 |



- `createOrder()`, `createTicket()`: 보상 트랜잭션을 가지고 있음
- `verifyConsumerDetails()`: 읽기 전용이라, 보상 트랜잭션이 필요 없음
- `authorizeCreditCard()`: 소비자 신용카드가 승인되면 반드시 완료됨
- `approveTicket()`, `approveOrder()`: 피봇 트랜잭션 이후의 트랜잭션


# 3. 해결책

## 1. 시맨틱 락

### 시맨틱 락이란?

- 보상 가능 트랜잭션이 생성/수정하는 레코드에 플래그를 세팅하는 애플리케이션 수준의 락
- 플래그는 다음 두 가지 역할을 수행할 수 있음
    
    
    
    - 해당 레코드를 다른 트랜잭션이 접근하지 못하게 락을 걸어 놓음
    - 해당 레코드를 처리하려는 다른 트랜잭션에게 경고를 보냄
    
    

### 플래그

- 플래그는 재시도 가능 트랜잭션(사가 완료), 보상 트랜잭션(사가 롤백)으로 해제
- 주문 생성 사가에서 주문은 `APPROVAL_PENDING` 상태로 생성되고, 마지막에 `APPROVED` 또는 `REJECTED` 상태로 변경됨

### 잠금 레코드 처리 (1): 실패 처리

- 커맨드 호출을 실패 처리하고, 클라이언트에게 나중에 시도하라고 알림
- 구현은 간단하나, 재시도 로직까지 구현해야 해 클라이언트가 복잡해짐

### 잠금 레코드 처리 (2): 블로킹

- 락이 해제될 때까지 시스템 커맨드를 블로킹해, 잠금 레코드를 처리

- ACID 트랜잭션 고유의 격리 기능을 되살릴 수 있음
- 같은 레코드를 업데이트하는 사가를 직렬화시킬 수 있어, 프로그래밍 부담이 줄어듬

- 클라이언트의 재시도 부담은 덜 수 있지만, 애플리케이션이 락을 관리해야
- 잠금된 레코드를 어떻게 사가로 처리할지는 사례별로 결정해야

## 2. 교환적 업데이트

- 업데이트 작업을 어떤 순서로 실행해도 되게끔 설계

- 마이너스 통장은 없다고 가정하면, `Account`의 `debit()`과 `credit()`은 교환적인 작업
    - 보상 가능 트랜잭션이 계좌의 `debit()` 호출 후 사가를 롤백해야 하는 상황 가정
    - 보상 트랜잭션은 단순히 계좌의 `credit()`을 호출해 해서 업데이트를 undo하면 됨
    

## 3. 비관적 관점

- 사가 단계 순서를 재조정해, 더티 읽기로 인한 비즈니스 리스크를 최소화

- 주문 취소 사가는 다음과 같은 트랜잭션으로 구성됨
    
    
    
    1. **소비자 서비스**: 신용 잔고를 늘림
    2. **주문 서비스**: 주문을 취소 상태로 변경
    3. **배달 서비스**: 배달을 취소
    
    

- 주문 취소/생성 사가의 실행이 겹친 상황에서 배달 취소 실패로 주문 취소 사가가 롤백되면, 다음처럼 트랜잭션 순서가 엉킬 수도
    
    
    
    1. **주문 취소 사가**: 신용 잔고를 늘림
    2. **주문 생성 사가**: 신용 잔고를 줄임
    3. **주문 취소 사가**: 신용 잔고를 줄이는 보상 트랜잭션을 가동
    4. **소비자**: 신용 한도를 초과하는 주문을 수행할 수 있게 됨
    
    

- 주문 취소 사가 단계를 다음과 같이 재조정하면, 더티 읽기 문제 발생 위험성을 줄일 수 있음
    
    
    
    1. **주문 서비스**: 주문을 취소 상태로 변경
    2. **배달 서비스**: 배달을 취소
    3. **회계 서비스**: 신용 잔고를 늘림
    
    
    - 신용 잔고는 재시도 가능 트랜잭션에서 증가해, 더티 읽기 가능성이 사라짐

## 4. 값 다시 읽기(낙관적 오프라인 락)

- 데이터를 덮어 쓸 때, 그 전에 변경된 내용은 없는지 값을 다시 읽고 확인해, 업데이트 소실 방지
    
    
    
    - **값이 변경되지 않음**: 업데이트 수행
    - **값이 변경됨**: 사가를 중단하고 나중에 다시 시작
    
    

- 주문 생성 사가에 적용하면, 주문 승인 중 주문이 취소되는 상황을 막을 수 있음
    
    
    
    - **주문이 변경되지 않음**: 주문 승인 처리
    - **주문이 변경됨(취소됨)**: 사가를 멈추고 보상 트랜잭션 가동