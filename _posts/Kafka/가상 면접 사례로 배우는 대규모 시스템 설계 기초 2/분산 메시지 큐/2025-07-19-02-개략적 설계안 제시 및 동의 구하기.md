---
layout: single
title: "2. 개략적 설계안 제시 및 동의 구하기"
categories:
  - Kafka
  - 가상 면접 사례로 배우는 대규모 시스템 설계 기초 2
  - 분산 메시지 큐
tags:
  - Kafka
  - 분산 메시지 큐
toc: true
toc_sticky: true
---
# 0. 핵심 컴포넌트 및 간략한 상호작용 흐름도

![pn0h50us.bmp](/assets/images/Kafka/가상 면접 사례로 배우는 대규모 시스템 설계 기초 2/분산 메시지 큐/02-개략적 설계안 제시 및 동의 구하기/pn0h50us.bmp)

- **생산자**: 메시지를 메시지 큐에 발행
- **소비자**: 큐를 구독하고 구독한 메시지를 소비
- **메시지 큐**: 생산자/소비자가 느슨하게 결합되어 독립적인 운영이 가능하도록 지원

---
# 1. 메시지 모델

## 1. 일대일 모델

- 큐에 전송된 메시지를 오직 한 소비자만 가져갈 수 있음
    - 어떤 소비자가 메시지를 가져갔다는 사실을 큐에 알리면(ACK), 해당 메시지는 큐에서 삭제됨

![25pm03pz.bmp](/assets/images/Kafka/가상 면접 사례로 배우는 대규모 시스템 설계 기초 2/분산 메시지 큐/02-개략적 설계안 제시 및 동의 구하기/25pm03pz.bmp)

## 2. 발행-구독 모델

- 토픽에 전달돤 메시지를 해당 토픽을 구독 중인 모든 소비자가 가져갈 수 있음

![4io43dsr.bmp](/assets/images/Kafka/가상 면접 사례로 배우는 대규모 시스템 설계 기초 2/분산 메시지 큐/02-개략적 설계안 제시 및 동의 구하기/4io43dsr.bmp)

# 2. 토픽, 파티션, 브로커

## 1. 토픽

- 메시지가 저장/관리되는 공간 단위로, 메시지를 주제별로 정리하는 데에 사용됨
    - 메시지를 보내고 받을 때, 토픽에 보내고 받음

## 2. 파티션

- 토픽에 보낼 메시지의 부분집합으로, 메시지의 순서가 유지됨
    - 파티션 내 메시지의 순서는 오프셋으로 표현

![jhu3eg31.bmp](/assets/images/Kafka/가상 면접 사례로 배우는 대규모 시스템 설계 기초 2/분산 메시지 큐/02-개략적 설계안 제시 및 동의 구하기/jhu3eg31.bmp)

- 생산자가 보낸 메시지는 해당 토픽의 파티션 중 하나로 보내짐
    - 같은 메시지 키를 가진 메시지는 같은 파티션으로 보내짐
    - 메시지 키가 없는 메시지는 무작위로 보내짐

- 토픽을 구독하는 소비자는 하나 이상의 파티션에서 데이터를 가져옴

## 3. 브로커

- 파티션을 유지하는 서버로, 파티션이 분산 배치됨

---
# 3. 소비자 그룹

- 같은 토픽을 구독하는 소비자의 집합
    - 각 소비자는 토픽을 구성하는 파티션의 일부를 담당해, 메시지 소비를 위해 협력
    - 같은 그룹 내 소비자는 메시지를 병렬로 소비할 수 있음
        - 예) 파티션 1 - 소비자 1, 파티션 2 - 소비자 2
    - 하나의 소비자 그룹은 여러 토픽을 구독할 수 있고, 오프셋을 별도로 관리
    
    ![15ys6rzm.bmp](/assets/images/Kafka/가상 면접 사례로 배우는 대규모 시스템 설계 기초 2/분산 메시지 큐/02-개략적 설계안 제시 및 동의 구하기/15ys6rzm.bmp)
    

## 1. 문제: 메시지 순서 보장

- 데이터를 병렬로 소비하면, 한 파티션 내의 메시지를 순서대로 소비할 수가 없음

## 2. 해결책: 한 그룹에서는 한 소비자만

- 파티션의 메시지를 그룹 내 한 소비자만 읽을 수 있도록 하면, 메시지 순서 보장이 가능
- 다만 그룹 내 소비자 수가 구독 토픽의 파티션 수보다 크면, 어떤 소비자는 해당 토픽에서 데이터를 읽을 수 없음
    - 다음 이미지에서 그룹 2의 소비자 3은 토픽 B의 메시지를 읽을 수 없음
    
    ![15ys6rzm.bmp](/assets/images/Kafka/가상 면접 사례로 배우는 대규모 시스템 설계 기초 2/분산 메시지 큐/02-개략적 설계안 제시 및 동의 구하기/15ys6rzm.bmp)
    
- 모든 소비자를 같은 소비자 그룹에 두면, 같은 파티션의 메시지는 오직 한 소비자만 가져갈 수 있어, 일대일 모델에 수렴하게 됨

---
# 4. 개략적 설계안

![p9pzjqbw.bmp](/assets/images/Kafka/가상 면접 사례로 배우는 대규모 시스템 설계 기초 2/분산 메시지 큐/02-개략적 설계안 제시 및 동의 구하기/p9pzjqbw.bmp)

## 1. 클라이언트

- **생산자**(Producer): 메시지를 특정 토픽으로 보냄
- **소비자**(Consumer): 토픽을 구독하고 메시지를 소비

## 2. 핵심 서비스

- **브로커**(Broker): 파티션들을 유지
- **파티션**(Partition): 특정 토픽에 대한 메시지의 부분 집합을 유지
- **조정 서비스**(Coordination Service)
    - **서비스 탐색**: 어떤 브로커가 살아 있는지 알려줌
    - **리더 선출**: 컨트롤러 역할을 담당해 파티션 배치를 책임질 브로커를 선출
    - **아파치 주키퍼 또는 etcd**: 컨트롤러 선출을 담당하는 컴포넌트

## 3. 저장소

- **데이터 저장소**(Data Storage): 메시지 보관
- **상태 저장소**(State Storage): 소비자 상태 보관
- **메타데이터 저장소**(Metadata Storage): 토픽 설정, 속성 보관