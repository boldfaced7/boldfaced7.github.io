---
layout: single
title: "1. 파티셔너"
categories:
  - Kafka
  - 실전 카프카 개발부터 운영까지
  - 프로듀서의 내부 동작 원리와 구현
tags:
  - Kafka
  - 실전 카프카 개발부터 운영까지
  - 프로듀서의 내부 동작 원리와 구현
toc: true
toc_sticky: true
---
# 0. 파티셔너란?

- 프로듀서가 토픽으로 전달한 메시지를 어느 파티션으로 보낼지 결정
    - 기본적으로 메시지 키를 해시 처리해 파티션을 구함
    - 따라서 메시지 키 값이 동일하면, 같은 파티션으로 전송됨

- 클라이언트 처리량을 높이기 위해, 토픽의 파티션을 늘릴 수 있음
- 파티션 수가 변경되면 해시테이블도 변경되어, 이전과 다른 파티션으로 전송될 수 있음
    
    ![20241217_192140.png](/assets/images/Kafka/실전 카프카 개발부터 운영까지/프로듀서의 내부 동작 원리와 구현/08-파티셔너/20241217_192140.png)
    
    - 관리자 의도와 다른 방식으로 메시지가 전송될 수 있어, 되도록 파티션 수를 변경하지 않아야

# 1. 라운드 로빈 전략

- 프로듀서가 메시지 키값을 지정하지 않는 경우, 각 파티션에 레코드를 순서대로 전송
- 파티셔너를 거친 후, 레코드들은 배치 처리를 위해 프로듀서의 버퍼 메모리 영역에 대기

- 라운드 로빈 전략은 레코드의 버퍼 대기 시간을 길게 만들어, 효율을 떨어트릴 수 있음
    - 각 파티션에 순서대로 할당해, 배치 전송을 위한 최소 레코드 수 충족에 오래 걸림
    
    ![20241217_192158.png](/assets/images/Kafka/실전 카프카 개발부터 운영까지/프로듀서의 내부 동작 원리와 구현/08-파티셔너/20241217_192158.png)
    
- 프로듀서 옵션을 조정해, 특정 시간을 초과하면 버퍼의 레코드를 즉시 전송하도록 설정 가능
- 하지만 이는 배치와 압축 효과를 얻지 못하게 해, 매우 비효율적
    - 토픽A-파티션2의 경우, 레코드 하나만 전송됨

# 2. 스티키 파티셔닝 전략

- 한 파티션에 레코드 수를 먼저 채워 카프카로 빠르게 배치 전송
    
    ![20241217_192208.png](/assets/images/Kafka/실전 카프카 개발부터 운영까지/프로듀서의 내부 동작 원리와 구현/08-파티셔너/20241217_192208.png)
    
- 라운드 로빈 전략에 비해 지연 시간이 30% 이상 감소하고, 프로듀서의 CPU 사용율도 줄어듦
- 전송 메시지의 순서가 중요하지 않은 경우, 스티키 파티셔닝 전략을 적용해야