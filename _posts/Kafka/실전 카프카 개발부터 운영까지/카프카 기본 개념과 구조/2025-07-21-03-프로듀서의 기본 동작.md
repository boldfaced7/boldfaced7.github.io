---
layout: single
title: "3. 프로듀서의 기본 동작"
categories:
  - Kafka
  - 실전 카프카 개발부터 운영까지
  - 카프카 기본 개념과 구조
tags:
  - Kafka
  - 실전 카프카 개발부터 운영까지
  - 카프카 기본 개념과 구조
toc: true
toc_sticky: true
---
# 1. 프로듀서 디자인

- 프로듀서는 특정 토픽으로 메시지를 전송

![20241217_184054.png](/assets/images/Kafka/실전 카프카 개발부터 운영까지/카프카 기본 개념과 구조/03-프로듀서의 기본 동작/20241217_184054.png)



## 1. 레코드

- 카프카로 전송하기 위한 실제 데이터
- 레코드 토픽, 밸류(메시지 내용): 필수
- 레코드 파티션, 키: 선택
    - 파티션: 특정 파티션 지정
    - 키: 파티션에서 레코드 정렬



## 2. 시리얼라이저, 파티셔너

- 레코드는 `send()`를 통해 시리얼라이저, 파티셔너를 거침
    - 레코드에 파티션 값 지정 시, 파티셔너는 아무 동작하지 않음
    - 파티셔너 기본 동작 방식: 라운드 로빈



## 3. 전송

- 배치 전송을 위해 프로듀서 내부에서 레코드를 파티션별로 잠시 모아둠
- 전송 성공 시, 메타데이터 반환
- 전송 실패 시, 지정된 횟수만큼 재시도
- 지정된 횟수만큼 재시도 실패 시, 최종 실패 처리

<br>

# 2. 프로듀서 예제

## 1. `ProducerFireForgot`: 메시지 전송 후 확인하지 않음

- 대부분 메시지 전송에 성공하나, 실제 운영 환경에서의 사용은 추천하지 않음

```java
@Component
@RequiredArgsConstructor
public class ProducerFireForgot {

private final KafkaTemplate<String, String> kafkaTemplate;

	public void sendMessage(String key, String value) {
		for (int i = 0; i < 3; i++) {
			ProducerRecord<String, String> record
					= new ProducerRecord<>("peter-basic01", key, value + " " + i);
					
			kafkaTemplate.send(record);
		}
	}
}
```

<br>

## 2. `ProducerSync`: 동기 전송

- `send()`: `CompletableFuture` 객체 반환
- `get()`: `CompletableFuture`를 기다려 전송 성공 여부 확인

```java
@Component
@RequiredArgsConstructor
public class ProducerSync {

private final KafkaTemplate<String, String> kafkaTemplate;

	public void sendMessage(String key, String value) 
			throws ExecutionException, InterruptedException {
			
		ProducerRecord<String, String> record
				= new ProducerRecord<>("peter-basic01", key, value);
		
		RecordMetadata metadata = kafkaTemplate.send(record)
				.get().getRecordMetadata();
		
		System.out.printf(
				"Topic: %s, Partition: %d, Offset: %d, Key: %s, Received: %s\n",
				metadata.topic(), metadata.partition(), 
				metadata.offset(), record.key(), record.value()
		);
	}
}
```

<br>

## 3. `ProducerAsync`: 비동기 전송

- `ProducerAsyncCallback`: 콜백 메서드 작성

```java
@Component
@RequiredArgsConstructor
public class ProducerAsyncCallback {

	public static void onCompletion(
			SendResult<String, String> result, 
			Throwable t
	) {
		Optional.ofNullable(t).ifPresent(t::printStackTrace);

		RecordMetadata metadata = result.getRecordMetadata();
		ProducerRecord<String, String> record = result.getProducerRecord();
		
		System.out.printf(
				"Topic: %s, Partition: %d, Offset: %d, Key: %s, Received: %s\n",
				metadata.topic(), metadata.partition(), 
				metadata.offset(), record.key(), record.value()
		);
	}
}
```

- `ProducerAsync`: `send()`와 콜백 메서드의 메서드 참조를 함께 전달

```java
@Component
@RequiredArgsConstructor
public class ProducerAsync {

	private final KafkaTemplate<String, String> kafkaTemplate;
	
	public void sendMessage(String key, String value) {
		for (int i = 0; i < 3; i++) {
			ProducerRecord<String, String> record
					= new ProducerRecord<>("peter-basic01", key, value);
			
			kafkaTemplate.send(record)
					.whenComplete(ProducerAsyncCallback::onCompletion);
		}
	}
}
```