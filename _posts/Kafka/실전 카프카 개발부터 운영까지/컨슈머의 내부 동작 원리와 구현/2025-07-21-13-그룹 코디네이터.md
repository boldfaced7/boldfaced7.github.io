---
layout: single
title: "2. 그룹 코디네이터"
categories:
  - Kafka
  - 실전 카프카 개발부터 운영까지
  - 컨슈머의 내부 동작 원리와 구현
tags:
  - Kafka
  - 실전 카프카 개발부터 운영까지
  - 컨슈머의 내부 동작 원리와 구현
toc: true
toc_sticky: true
---
# 컨슈머 리밸런싱

- 컨슈머 그룹에서 각 컨슈머들에게 작업을 균등하게 분해하는 동작
- 리밸런싱 작업이 일어나는 동안 컨슈머들은 일시 중지됨

# 그룹 코디네이터

- 안정적인 컨슈머 그룹 관리를 위해, 한 그룹이 구독한 토픽의 파티션, 그룹 멤버를 트래킹
    
    ![20241217_192631.png](/assets/images/Kafka/실전 카프카 개발부터 운영까지/컨슈머의 내부 동작 원리와 구현/13-그룹 코디네이터/20241217_192631.png)
    
- 파티션/그룹 멤버에 변화 발생 시, 작업의 균등한 재분배를 위해 컨슈머 리밸런싱 수행

# 동작

![20241217_192653.png](/assets/images/Kafka/실전 카프카 개발부터 운영까지/컨슈머의 내부 동작 원리와 구현/13-그룹 코디네이터/20241217_192653.png)

1. **컨슈머**: 브로커에게 커넥션 연결을 위한 요청 전송
2. **브로커**: 그룹 코디네이터를 생성해 응답
    - 첫 컨슈머 등록 전에는 아무 작업도 일어나지 않음
3. **코디네이터**: 컨슈머의 요청 대기
4. **컨슈머**: 그룹 코디네이터에게 컨슈머 등록 요청 전송
    - 가장 먼저 요청하는 컨슈머가 그룹 리더로 선정됨
5. **코디네이터**: 컨슈머 그룹 토픽 파티션 리스트 등으로 응답
6. **리더 컨슈머**: 그룹 내 컨슈머들에게 파티션 할당 뒤 코디네이터에게 전달
7. **코디네이터**: 해당 정보를 캐시하고 각 그룹 내 컨슈머들에게 성공을 알림
8. **각 컨슈머**: 지정된 토픽 파티션으로부터 메시지들을 가져옴

# heartbeat

- 컨슈머의 변경을 감지하기 위해, 그룹 코디네이터와 서로 주고받는 메시지
- 컨슈머 하트비트 기본 설정
    
    ```yaml
    # 하트비트 인터벌 시간, session.timeout.ms보다 낮게 설정해야
    heartbeat.interval.ms=3000
    # 컨슈머 타임아웃 시간, 만료 시 해당 컨슈머 제거 후 리밸런싱
    session.timeout.ms=10000
    # poll() 호출 이후 대기 시간, 초과 시 해당 컨슈머 제거 후 리밸런싱
    max.poll.interval.ms=300000
    ```
    
    - heartbeat뿐만 아니라, `poll()` 동작 여부로 컨슈머를 파악

# 주의사항

- 가급적 리밸런싱이 자주 발생하지 않도록 주의해야
    - 리밸런싱 동작이 매우 비쌈

- 가능하면 heatbeat 기본 설정을 유지해야
    - 빠른 감지 설정: 리밸런싱이 잦아짐
    - 느린 감지 설정: 설정한 시간만큼 해당 파티션 메시지를 읽지 못함