---
layout: single
title: "2. 컨트롤러"
categories:
  - Kafka
  - 실전 카프카 개발부터 운영까지
  - 카프카의 내부 동작 원리와 구현
tags:
  - Kafka
  - 실전 카프카 개발부터 운영까지
  - 카프카의 내부 동작 원리와 구현
toc: true
toc_sticky: true
---
# 1. 컨트롤러란?

## 1. 리더 선출

- 파티션 ISR 리스트에서 리더를 선출
    - 가용성 보장을 위해 ISR 리스트 정보는 주키퍼에 저장되어 있음

- 브로커의 실패 감지 시, ISR 리스트 중 하나를 새로운 파티션 리더로 선출
- 새로운 리더 정보를 주키퍼에 기록하고, 모든 브로커에 전달

## 2. 리더 다운?

- 파티션의 리더가 없는 상태로, 프로듀서/컨슈머의 읽기/쓰기 동작은 실패하게 됨
    - 클라이언트는 설정된 재시도 숫자만큼 재시도

# 2. 장애로 인한 브로커 종료

![20241217_192031.png](/assets/images/Kafka/실전 카프카 개발부터 운영까지/카프카의 내부 동작 원리와 구현/06-컨트롤러/20241217_192031.png)

1. **리더(브로커)**: 0번 파티션의 리더가 있는 브로커가 장애로 다운
2. **주키퍼**: 브로커와 연결이 끊어진 후, 0번 파티션 ISR에 변화 발생을 감지
3. **컨트롤러**: 0번 파티션 ISR 중 새로운 리더를 선출
    - 컨트롤러는 주키퍼 워치를 통해 0번 파티션의 변화를 감지
4. **컨트롤러**: 0번 파티션의 새 리더에 대한 정보를 주키퍼에 기록
5. **컨트롤러**: 갱신된 정보를 활성화 상태인 모든 브로커에 전파

- 브로커 다운 시부터 새로운 리더 선출 시까지 다운타임 발생
    - 컨트롤러가 순차적으로 각 파티션의 리더를 선출
    - 마지막 파티션의 다운타임이 제일 길어짐

# 3. 제어된 브로커 종료

![20241217_192048.png](/assets/images/Kafka/실전 카프카 개발부터 운영까지/카프카의 내부 동작 원리와 구현/06-컨트롤러/20241217_192048.png)

1. **브로커**: 관리자로부터 `SIG_TERM` 신호를 전달 받음
2. **브로커**: 컨트롤러에게 종료 요청을 전달
3. **컨트롤러**: 종료 응답 이전에 새로운 리더를 선출하고, 해당 정보를 주키퍼에 기록
4. **컨트롤러**: 새로운 리더 정보를 모든 브로커에 전파
5. **컨트롤러**: 종료 요청을 보낸 브로커에게 정상 종료 응답을 전달
6. **브로커**: 캐시에 있는 내용을 디스크에 저장하고 종료

- 제어된 종료는 파티션의 다운타임을 최소화할 수 있음
    - 브로커 종료 전에 새로운 리더를 선출하기 때문
    - 물론 리더 선출 작업 시간 동안 일시적인 다운타임 발생

- 종료된 브로커의 재시작 시, 로그 복구 시간이 짧음
    - 종료 이전에 로그를 디스크에 동기화했기 때문